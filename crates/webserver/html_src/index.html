<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Calendar App</title>
        <link rel="stylesheet" href="calendar.css" />
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    </head>
    <body>
        <div id="app" class="theme-light">
            <!-- Toolbar -->
            <div class="toolbar">
                <button id="menu-btn" class="menu-btn">‚ò∞</button>

                <div class="date-navigation desktop-only">
                    <button id="prev-btn" class="nav-btn">‚Äπ</button>
                    <div class="date-selector">
                        <span id="current-date">January 2025</span>
                        <select id="date-picker" class="date-picker">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <button id="next-btn" class="nav-btn">‚Ä∫</button>
                </div>

                <div class="view-controls desktop-only">
                    <div id="toolbar-timezone-container" style="display: inline-flex; align-items: center; margin-right: 1rem">
                        <label for="view-timezone" style="font-size: 0.95rem; font-weight: 500; margin-right: 0.5rem">Timezone:</label>
                        <select id="view-timezone" style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; border: 1px solid #ccc; font-size: 0.95rem"></select>
                    </div>
                    <button id="day-view" class="view-btn active">Day</button>
                    <button id="week-view" class="view-btn">Week</button>
                    <button id="month-view" class="view-btn">Month</button>
                </div>

                <!-- Redesigned theme toggle with slider and animated backgrounds -->
                <div id="theme-toggle" class="theme-toggle">
                    <div class="theme-slider">
                        <div class="theme-background">
                            <div class="light-bg">
                                <div class="cloud"></div>
                            </div>
                            <div class="dark-bg">
                                <div class="star"></div>
                                <div class="star"></div>
                                <div class="star"></div>
                            </div>
                        </div>
                        <div class="theme-handle">
                            <span class="sun">‚òÄÔ∏è</span>
                            <span class="moon">üåô</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Side Menu -->
            <div id="side-menu" class="side-menu">
                <div class="menu-content">
                    <h2>Calendar Menu</h2>

                    <!-- Mobile Date Selector and Navigation -->
                    <div class="menu-section mobile-only" style="margin-bottom: 1rem">
                        <div class="section-content" style="display: block">
                            <div id="side-date-navigation" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 1rem">
                                <button id="side-prev-btn" class="nav-btn">‚Äπ</button>
                                <div class="date-selector">
                                    <span id="side-current-date">January 2025</span>
                                    <select id="side-date-picker" class="date-picker">
                                        <!-- Options populated by JS -->
                                    </select>
                                </div>
                                <button id="side-next-btn" class="nav-btn">‚Ä∫</button>
                            </div>
                            <div id="side-timezone-container" style="margin-bottom: 1rem">
                                <label for="side-view-timezone" style="font-size: 0.95rem; font-weight: 500; margin-right: 0.5rem">Timezone:</label>
                                <select id="side-view-timezone" style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; border: 1px solid #ccc; font-size: 0.95rem"></select>
                            </div>
                            <div id="side-view-controls" style="display: flex; gap: 0.5rem; margin-bottom: 1rem">
                                <button id="side-day-view" class="view-btn active">Day</button>
                                <button id="side-week-view" class="view-btn">Week</button>
                                <button id="side-month-view" class="view-btn">Month</button>
                            </div>
                        </div>
                    </div>
                    <!-- Create Event Section -->
                    <div class="menu-section">
                        <button class="section-toggle" data-target="create-event">
                            <span>Create Event</span>
                            <span class="arrow">‚ñº</span>
                        </button>
                        <div id="create-event" class="section-content">
                            <form id="event-form">
                                <div class="form-group">
                                    <label>Calendar</label>
                                    <select id="event-calendar">
                                        <option value="" disabled selected>Make a selection</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Title</label>
                                    <input type="text" id="event-title" required />
                                </div>

                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea id="event-description"></textarea>
                                </div>

                                <div class="form-group">
                                    <label>Location</label>
                                    <input type="text" id="event-location" />
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Start Date</label>
                                        <input type="date" id="event-start-date" required />
                                    </div>
                                    <div class="form-group">
                                        <label>Start Time</label>
                                        <input type="time" id="event-start-time" required />
                                    </div>
                                </div>
                                <script>
                                    // --- Deduped IANA Timezone Logic ---
                                    const PREFERENCE_ORDER = [
                                        "America/Los_Angeles",
                                        "America/Phoenix",
                                        "America/Denver",
                                        "America/Chicago",
                                        "America/New_York",
                                        "America/Anchorage",
                                        "Pacific/Honolulu",
                                        "America/Vancouver",
                                        "America/Edmonton",
                                        "America/Winnipeg",
                                        "America/Toronto",
                                        "America/Mexico_City",
                                        "America/Bogota",
                                        "America/Lima",
                                        "America/Caracas",
                                        "America/Santiago",
                                        "America/Sao_Paulo",
                                        "America/Montevideo",
                                        "America/Asuncion",
                                        "Europe/London",
                                        "Europe/Dublin",
                                        "Europe/Berlin",
                                        "Europe/Paris",
                                        "Europe/Madrid",
                                        "Europe/Rome",
                                        "Europe/Warsaw",
                                        "Europe/Athens",
                                        "Europe/Bucharest",
                                        "Europe/Helsinki",
                                        "Europe/Istanbul",
                                        "Europe/Moscow",
                                        "Asia/Dubai",
                                        "Asia/Qatar",
                                        "Asia/Riyadh",
                                        "Asia/Tehran",
                                        "Asia/Jerusalem",
                                        "Africa/Cairo",
                                        "Africa/Johannesburg",
                                        "Africa/Nairobi",
                                        "Africa/Casablanca",
                                        "Asia/Kabul",
                                        "Asia/Karachi",
                                        "Asia/Kolkata",
                                        "Asia/Dhaka",
                                        "Asia/Yangon",
                                        "Asia/Bangkok",
                                        "Asia/Jakarta",
                                        "Asia/Singapore",
                                        "Asia/Hong_Kong",
                                        "Asia/Shanghai",
                                        "Asia/Taipei",
                                        "Asia/Tokyo",
                                        "Asia/Seoul",
                                        "Australia/Perth",
                                        "Australia/Adelaide",
                                        "Australia/Sydney",
                                        "Pacific/Auckland",
                                        "Pacific/Fiji",
                                        "Pacific/Tongatapu",
                                        "Etc/UTC",
                                        "UTC",
                                        "Etc/GMT",
                                    ];
                                    const FALLBACK_TIMEZONES = [
                                        "Etc/UTC",
                                        "Etc/GMT",
                                        "Pacific/Honolulu",
                                        "America/Anchorage",
                                        "America/Los_Angeles",
                                        "America/Phoenix",
                                        "America/Denver",
                                        "America/Chicago",
                                        "America/New_York",
                                        "America/Mexico_City",
                                        "America/Bogota",
                                        "America/Lima",
                                        "America/Caracas",
                                        "America/Santiago",
                                        "America/Sao_Paulo",
                                        "Europe/London",
                                        "Europe/Dublin",
                                        "Europe/Berlin",
                                        "Europe/Paris",
                                        "Europe/Madrid",
                                        "Europe/Rome",
                                        "Europe/Warsaw",
                                        "Europe/Athens",
                                        "Europe/Bucharest",
                                        "Europe/Helsinki",
                                        "Europe/Istanbul",
                                        "Europe/Moscow",
                                        "Africa/Cairo",
                                        "Africa/Johannesburg",
                                        "Africa/Nairobi",
                                        "Africa/Casablanca",
                                        "Asia/Dubai",
                                        "Asia/Qatar",
                                        "Asia/Riyadh",
                                        "Asia/Tehran",
                                        "Asia/Jerusalem",
                                        "Asia/Kabul",
                                        "Asia/Karachi",
                                        "Asia/Kolkata",
                                        "Asia/Dhaka",
                                        "Asia/Yangon",
                                        "Asia/Bangkok",
                                        "Asia/Jakarta",
                                        "Asia/Singapore",
                                        "Asia/Hong_Kong",
                                        "Asia/Shanghai",
                                        "Asia/Taipei",
                                        "Asia/Tokyo",
                                        "Asia/Seoul",
                                        "Australia/Perth",
                                        "Australia/Adelaide",
                                        "Australia/Sydney",
                                        "Pacific/Auckland",
                                        "Pacific/Fiji",
                                        "Pacific/Tongatapu",
                                    ];
                                    function tzOffsetMinutes(timeZone, date) {
                                        try {
                                            const dtf = new Intl.DateTimeFormat("en-US", {
                                                timeZone,
                                                hour12: false,
                                                year: "numeric",
                                                month: "2-digit",
                                                day: "2-digit",
                                                hour: "2-digit",
                                                minute: "2-digit",
                                                second: "2-digit",
                                            });
                                            const parts = Object.fromEntries(dtf.formatToParts(date).map((p) => [p.type, p.value]));
                                            const asUTC = Date.UTC(Number(parts.year), Number(parts.month) - 1, Number(parts.day), Number(parts.hour), Number(parts.minute), Number(parts.second));
                                            return Math.round((asUTC - date.getTime()) / 60000);
                                        } catch {
                                            return 0;
                                        }
                                    }
                                    function buildSignature(timeZone, year = new Date().getUTCFullYear()) {
                                        const stamps = [];
                                        for (let m = 0; m < 12; m++) {
                                            const d = new Date(Date.UTC(year, m, 1, 0, 0, 0));
                                            stamps.push(tzOffsetMinutes(timeZone, d));
                                        }
                                        return stamps.join(",");
                                    }
                                    function dedupeBySignature(zones, year = new Date().getUTCFullYear()) {
                                        const groups = new Map();
                                        for (const tz of zones) {
                                            try {
                                                const sig = buildSignature(tz, year);
                                                if (!groups.has(sig)) groups.set(sig, new Set());
                                                groups.get(sig).add(tz);
                                            } catch {}
                                        }
                                        return groups;
                                    }
                                    function chooseRepresentatives(groups) {
                                        const preferredIndex = new Map(PREFERENCE_ORDER.map((tz, i) => [tz, i]));
                                        const reps = [];
                                        for (const set of groups.values()) {
                                            const candidates = Array.from(set);
                                            candidates.sort((a, b) => {
                                                const ai = preferredIndex.has(a) ? preferredIndex.get(a) : Infinity;
                                                const bi = preferredIndex.has(b) ? preferredIndex.get(b) : Infinity;
                                                if (ai !== bi) return ai - bi;
                                                return a.localeCompare(b);
                                            });
                                            reps.push(candidates[0]);
                                        }
                                        reps.sort((a, b) => a.localeCompare(b));
                                        return reps;
                                    }
                                    function getAllTimeZones() {
                                        if (typeof Intl.supportedValuesOf === "function") {
                                            try {
                                                const list = Intl.supportedValuesOf("timeZone");
                                                if (Array.isArray(list) && list.length) return list;
                                            } catch {}
                                        }
                                        return FALLBACK_TIMEZONES;
                                    }
                                    function getUniqueTimeZones(options = {}) {
                                        const { year = new Date().getUTCFullYear() } = options;
                                        const zones = getAllTimeZones();
                                        const groups = dedupeBySignature(zones, year);
                                        return chooseRepresentatives(groups);
                                    }
                                    function detectUserTimezone() {
                                        return Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
                                    }
                                    function populateTimezoneDropdown() {
                                        const IANATimezones = getUniqueTimeZones();
                                        // Event form
                                        const tzSelect = document.getElementById("event-timezone");
                                        if (tzSelect) {
                                            tzSelect.innerHTML = "";
                                            IANATimezones.forEach((tz) => {
                                                const opt = document.createElement("option");
                                                opt.value = tz;
                                                opt.textContent = tz;
                                                tzSelect.appendChild(opt);
                                            });
                                            const detected = detectUserTimezone();
                                            tzSelect.value = IANATimezones.includes(detected) ? detected : "UTC";
                                        }
                                        // Desktop view
                                        const viewTzSelect = document.getElementById("view-timezone");
                                        if (viewTzSelect) {
                                            viewTzSelect.innerHTML = "";
                                            IANATimezones.forEach((tz) => {
                                                const opt = document.createElement("option");
                                                opt.value = tz;
                                                opt.textContent = tz;
                                                viewTzSelect.appendChild(opt);
                                            });
                                            const detected = detectUserTimezone();
                                            viewTzSelect.value = IANATimezones.includes(detected) ? detected : "UTC";
                                        }
                                        // Mobile/side menu
                                        const sideTzSelect = document.getElementById("side-view-timezone");
                                        if (sideTzSelect) {
                                            sideTzSelect.innerHTML = "";
                                            IANATimezones.forEach((tz) => {
                                                const opt = document.createElement("option");
                                                opt.value = tz;
                                                opt.textContent = tz;
                                                sideTzSelect.appendChild(opt);
                                            });
                                            const detected = detectUserTimezone();
                                            sideTzSelect.value = IANATimezones.includes(detected) ? detected : "UTC";
                                        }
                                    }
                                    document.addEventListener("DOMContentLoaded", populateTimezoneDropdown);
                                </script>
                                <div class="form-group">
                                    <label for="event-timezone">Timezone</label>
                                    <select id="event-timezone"></select>
                                </div>

                                <!-- Added toggle for duration vs end date/time -->
                                <div class="form-group">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="use-duration" />
                                        Use duration instead of end time
                                    </label>
                                </div>

                                <div id="end-time-section" class="form-row">
                                    <div class="form-group">
                                        <label>End Date</label>
                                        <input type="date" id="event-end-date" />
                                    </div>
                                    <div class="form-group">
                                        <label>End Time</label>
                                        <input type="time" id="event-end-time" />
                                    </div>
                                </div>

                                <div id="duration-section" class="form-group" style="display: none">
                                    <label>Duration</label>
                                    <div class="duration-inputs">
                                        <input type="number" id="duration-hours" min="0" max="23" placeholder="Hours" />
                                        <input type="number" id="duration-minutes" min="0" max="59" placeholder="Minutes" />
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="event-recurring" />
                                        Recurring Event
                                    </label>
                                </div>

                                <!-- Enhanced recurring options with proper structure -->
                                <div id="recurring-options" class="recurring-options" style="display: none">
                                    <div class="form-group">
                                        <label>Repeat</label>
                                        <select id="recurrence-type">
                                            <option value="" disabled selected>Make a selection</option>
                                            <option value="daily">Daily</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="yearly">Yearly</option>
                                            <option value="custom">Custom</option>
                                        </select>
                                    </div>

                                    <div id="custom-recurrence" class="form-group" style="display: none">
                                        <label>Custom Interval</label>
                                        <div class="custom-inputs">
                                            <input type="number" id="custom-years" placeholder="Years" min="0" />
                                            <input type="number" id="custom-months" placeholder="Months" min="0" />
                                            <input type="number" id="custom-days" placeholder="Days" min="0" />
                                            <input type="number" id="custom-hours" placeholder="Hours" min="0" />
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="toggle-label">
                                            <input type="checkbox" id="limit-recurrences" />
                                            Limit number of occurrences
                                        </label>
                                    </div>

                                    <div id="recurrence-count-section" class="form-group" style="display: none">
                                        <label>Number of occurrences</label>
                                        <input type="number" id="recurrence-count" min="1" max="999" placeholder="e.g., 10" />
                                    </div>

                                    <div class="recurrence-info">
                                        <small>Default: Repeats indefinitely</small>
                                    </div>
                                </div>
                                <!-- Add Event Button fixed to bottom -->
                                <div class="create-event-footer">
                                    <button type="submit" class="create-btn" id="add-event-btn">Add Event</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Import Events Section -->
                    <div class="menu-section">
                        <button class="section-toggle" data-target="import-events">
                            <span>Import Events</span>
                            <span class="arrow">‚ñº</span>
                        </button>
                        <div id="import-events" class="section-content">
                            <div class="form-group">
                                <label>Calendar</label>
                                <select id="import-calendar">
                                    <option value="" disabled selected>Make a selection</option>
                                </select>
                            </div>

                            <div class="file-upload">
                                <input type="file" id="file-input" accept=".ics,.csv" style="display: none" />
                                <button type="button" id="browse-btn" class="browse-btn">Browse Files</button>

                                <div id="drop-zone" class="drop-zone">
                                    <p>Drag and drop files here</p>
                                    <p class="file-types">Supported: .ics, .csv</p>
                                </div>

                                <button type="button" id="import-btn" class="import-btn">Import Events</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Calendar Area -->
            <div id="calendar-container" class="calendar-container">
                <!-- Day View -->
                <div id="day-view-container" class="view-container active">
                    <div class="time-column">
                        <!-- Time labels populated by JS -->
                    </div>
                    <div class="day-column">
                        <div class="day-grid">
                            <!-- Time slots populated by JS -->
                        </div>
                        <div class="current-time-line" style="display: none"></div>
                    </div>
                </div>

                <!-- Week View -->
                <div id="week-view-container" class="view-container">
                    <div class="time-column">
                        <!-- Time labels populated by JS -->
                    </div>
                    <div class="week-days">
                        <!-- Day columns populated by JS -->
                    </div>
                </div>

                <!-- Month View -->
                <div id="month-view-container" class="view-container">
                    <div class="month-header">
                        <!-- Day names -->
                    </div>
                    <div class="month-grid">
                        <!-- Calendar cells populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <script src="calendar.js"></script>
        <script>

                const tzSelect = document.getElementById("event-timezone");
                if (tzSelect) {
                    tzSelect.innerHTML = "";
                    IANATimezones.forEach((tz) => {
                        const opt = document.createElement("option");
                        opt.value = tz;
                        opt.textContent = tz;
                        tzSelect.appendChild(opt);
                    });
                    const detected = detectUserTimezone();
                    tzSelect.value = IANATimezones.includes(detected) ? detected : "UTC";
                }
                // For week/month view timezone dropdown (desktop)
                const viewTzSelect = document.getElementById("view-timezone");
                if (viewTzSelect) {
                    viewTzSelect.innerHTML = "";
                    IANATimezones.forEach((tz) => {
                        const opt = document.createElement("option");
                        opt.value = tz;
                        opt.textContent = tz;
                        viewTzSelect.appendChild(opt);
                    });
                    const detected = detectUserTimezone();
                    viewTzSelect.value = IANATimezones.includes(detected) ? detected : "UTC";
                }
                // For week/month view timezone dropdown (mobile/side menu)
                const sideTzSelect = document.getElementById("side-view-timezone");
                if (sideTzSelect) {
                    sideTzSelect.innerHTML = "";
                    IANATimezones.forEach((tz) => {
                        const opt = document.createElement("option");
                        opt.value = tz;
                        opt.textContent = tz;
                        sideTzSelect.appendChild(opt);
                    });
                    const detected = detectUserTimezone();
                    sideTzSelect.value = IANATimezones.includes(detected) ? detected : "UTC";
                }
            }
            document.addEventListener("DOMContentLoaded", populateTimezoneDropdown);

            // --- Mobile/desktop view control sync ---
            function syncViewControls() {
                // Mobile view controls
                const sideDay = document.getElementById("side-day-view");
                const sideWeek = document.getElementById("side-week-view");
                const sideMonth = document.getElementById("side-month-view");
                // Desktop view controls
                const day = document.getElementById("day-view");
                const week = document.getElementById("week-view");
                const month = document.getElementById("month-view");
                if (sideDay && day) {
                    sideDay.onclick = () => day.click();
                    day.onclick = () => sideDay.classList.add("active");
                }
                if (sideWeek && week) {
                    sideWeek.onclick = () => week.click();
                    week.onclick = () => sideWeek.classList.add("active");
                }
                if (sideMonth && month) {
                    sideMonth.onclick = () => month.click();
                    month.onclick = () => sideMonth.classList.add("active");
                }
            }
            document.addEventListener("DOMContentLoaded", syncViewControls);

            // --- Timezone dropdown sync (desktop <-> mobile) ---
            function syncTimezoneDropdowns() {
                const desktopTz = document.getElementById("view-timezone");
                const sideTz = document.getElementById("side-view-timezone");
                function sync(from, to) {
                    if (from && to) {
                        to.value = from.value;
                    }
                }
                if (desktopTz && sideTz) {
                    desktopTz.addEventListener("change", () => sync(desktopTz, sideTz));
                    sideTz.addEventListener("change", () => sync(sideTz, desktopTz));
                }
            }
            document.addEventListener("DOMContentLoaded", syncTimezoneDropdowns);
        </script>
        <script>
            // JS to hide .mobile-only elements on desktop and show on mobile
            function updateMobileOnlyVisibility() {
                const isMobile = window.matchMedia("(max-width: 48rem)").matches;
                document.querySelectorAll(".mobile-only").forEach((el) => {
                    el.style.display = isMobile ? "block" : "none";
                });
            }
            window.addEventListener("resize", updateMobileOnlyVisibility);
            document.addEventListener("DOMContentLoaded", updateMobileOnlyVisibility);
        </script>
    </body>
</html>
